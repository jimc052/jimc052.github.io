<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Monkey Script</title>
    <style>
      * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        user-select: none;
        font-family: 'Times New Roman', 'Helvetica Neue', 微軟正黑體, 'Microsoft Jhenghei', Helvetica, Arial, sans-serif;
        font-size: 16px;
      }
      html, body {
        min-height: 100% !important;
        height: 100%;
      }
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          line-height: 1.6;
          margin: 0;
          /* padding: 20px; */
          color: #333;
            display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      footer {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 5px 10px;
        border-top: 1px solid #ddd;
      }
      .left {
        height: 100%;
        flex: 1;
        padding: 0px 10px;
        background-color: #f4f4f4;
        margin-right: 2px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }
      .right {
        height: 100%;
        border-left: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .right, .right > div, table{
        width: 400px;
      }
      button + button {
        margin-left: 10px;
      }
      button {
        min-width: 100px;
        font-size: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 4px 4px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2; 
        text-align: center;
        position: sticky;
        top: 0;
      }
      tr.editing td {
        padding: 2px;
        background-color: #f2f2f2 ;
      }
      tr.focused {
        background-color: #c63300;
        color: #fff;
      }
      th:nth-child(1) {
        min-width: 100px;
      }
      th:nth-child(2), th:nth-child(3), th:nth-child(4) {
        width: 70px;
      }
      td:nth-child(2), td:nth-child(3), td:nth-child(4) {
        text-align: right;
      }
      th:nth-child(5), td:nth-child(5) {
        width: 40px;
      }
      td:nth-child(5) {
        background-image: url(./bin.png);
        background-size: 20px 20px; /* or contain */
        background-position: center;
        background-repeat: no-repeat;
        cursor: pointer;
        padding: 5px;
      }
      #_cursor {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: radial-gradient(transparent 30%, lightcoral, red 20%,  darkred);
        visibility: hidden;
      }
    </style>
    <script type="text/javascript" src="./tables.js"></script>
</head>
<body style="visibility: hidden;">
  <!-- <header> <button>腳本</button>  </header> -->
  <main>
    <section class="left">
      <img style="display: none;" />
      <div id="_cursor"></div>
    </section>

    <section class="right">
      <div style="overflow: auto; flex: 1;">
        <table id="table" style="width: 100%;">
          <tr><th>標題</th><th>座標 X</th><th>座標 Y</th><th>時間</th><th></th></tr>
        </table>        
      </div>
      <div id="log" style="display: none; height: 120px; overflow: auto; border-top: 1px solid #ddd; padding: 5px;">

      </div>
    </section>
  </main>

  <footer >
    <div style="width: 220px;">
      <span id="xy">座標 X： ，座標 Y：</span>
    </div>

    <div id="msg" style="flex: 1; text-align: center;"></div>
    <button id="btnClear" disabled>清空</button>
    <button id="btnMonkey" disabled>執行腳本</button>
    <select id="select" style="margin-left: 10px; font-size: 20px;"></select>
  </footer>

  <script>
    let ds = [], clsTable;
    const img = document.querySelector('.left img');
    const leftSection = document.querySelector('.left');
    // const rightSection = document.querySelector('.right');
    const log = document.getElementById('log');
    const xyLabel = document.getElementById('xy');
    const btnClear = document.getElementById('btnClear');
    const btnMonkey = document.getElementById('btnMonkey');
    const select = document.getElementById('select');
    const _cursor = document.getElementById('_cursor'); // 座標，紅色點
    let msg = document.getElementById('msg');
    const ws = new WebSocket("ws://localhost:8080");
    let scale = 1, orginalWidth = 0, cursorId;
    let imgLoading = false, recording = false,
      execTimes = 0, maxTimes = 1, startTime = null, logIntervalId;

    ws.onopen = function() {
      sendMsg("WebSocket 連線已開啟");
    }; 
    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if(data.type === "screenshot") { // 收到截圖資料
        imageLoad(true)
        img.src = data.message;
      } 
      else if(data.type === "error") {
        alert("錯誤訊息: \n" + data.message);
      } 
      else if(data.type === "tap") {
        if(typeof data.index == "number"){
          setTimeout(() => {
            execScript(data)  
          }, data.ms);
        }
      }
      else {
        console.log("收到訊息:", event.data);
      }
    };
    ws.onclose = function() {
      sendMsg("WebSocket 連線已關閉");
    };
    ws.onerror = function(error) {
      sendMsg("WebSocket 連線發生錯誤:", error);
    };

    window.onload = function() {
      console.log("window.onload: " + (new Date()).toLocaleTimeString('zh-Hant', { hour12: false }));
      let s = window.localStorage["monkey_script"];
      if(s && s.length > 0) {
        try {
          ds = JSON.parse(s);
          checkButton();
        } catch (err) {
          alert("localStorage 中的 JSON 解析錯誤: \n" + err.message);
        } 
      }
      
      clsTable = new Table({
        onclick: (index) => {
          let data = ds[index];
          moveCursor(data)
        }, 
        onmsg: (params) => {
          sendMsg(params)
        },
      })

      let options = [1, 2, 5, 10, 15, 20, 25, 30, 40, 50, 75, 100]
      options.forEach(el => { // 新增選項到下拉選單
        addOption(`${el} 次`, el);
      });
      select.addEventListener('change', function(e) {
        maxTimes = e.target.value;
      });

      img.onload = function() {
        imageLoad(false);
        if(orginalWidth !== img.naturalWidth) {
          const body = document.querySelector('body');
          body.style.visibility = 'visible';

          let clientWidth = leftSection.clientWidth - 20;

          orginalWidth = img.naturalWidth;
          let w = (img.naturalWidth / clientWidth);
          let h = (img.naturalHeight / leftSection.clientHeight);
          if(h > w) {
            scale = h;
            img.height = leftSection.clientHeight;
          } else {
            scale = w;
            img.width = clientWidth;
          }
          img.style.display = 'block';          
        }
      };
    };

    window.onbeforeunload = function() {
      ws.close();
    };

    function moveCursor(params) {
      clearTimeout(cursorId);
      const x = params.x / scale;
      const y = params.y / scale;
      _cursor.style.left = (img.offsetLeft + x - 12) + "px";
      _cursor.style.top = (img.offsetTop + y - 11) + "px";
      _cursor.style.visibility = "visible";
      cursorId =  setTimeout(() => {
        _cursor.style.visibility = "hidden";
      }, (execTimes == 0 ? 1 : 3 ) * 1000);
    }

    img.addEventListener('mousemove', function(e) {
      const x = Math.round(e.offsetX * scale);
      const y = Math.round(e.offsetY * scale);
      if(x < 0 || y < 0 || x > img.naturalWidth || y > img.naturalHeight) {
        xyLabel.textContent = `座標 X： ，座標 Y： `;
      } else {
        xyLabel.textContent = `座標 X： ${x}，座標 Y： ${y}`;
      }
    });
    img.addEventListener('click', function(e) {
      if(imgLoading == true || execTimes > 0) return;
      const x = Math.round(e.offsetX * scale);
      const y = Math.round(e.offsetY * scale);

      if(x >= 0 && y >= 0) {
        let now = (new Date()).getTime();
        if(startTime == null) {
          startTime = now;
        } 
        else if(ds.length > 0) {
          let index = ds.length - 1;
          let data = ds[index];
          let ms = Math.floor((now - startTime) / 1000) * 1000;
          ds[index].ms = ms == 0 ? 1000 : ms;
          clsTable.updateCell4(index, data.ms);
          startTime = now;
        }
        let data = {title: titleName(), x: x, y: y, ms: 5000};
        ds.push(data);
        clsTable.insertRow(data)
        window.localStorage["monkey_script"] = JSON.stringify(ds, null, 2);
        ws.send(JSON.stringify({type: "tap", x: x, y: y}));
        checkButton();
      }
    });

    function titleName() {
      let serialNumber = ds.length + 1;
      let title = `第 ${String(serialNumber).padStart(2, '0')} 次`;
      while (ds.find(d => d.title == title)) {
        serialNumber++;
        title = `第 ${String(serialNumber).padStart(2, '0')} 次`;
      }
      return title;
    }

    function imageLoad(params) {
      imgLoading = params;
      // if(params == false)
      //   img.classList.remove('loading');
      // else
      //   img.classList.add('loading');
    }

    btnMonkey.addEventListener('click', function(e) {
      // console.log(btnMonkey.innerText)
      if(btnMonkey.innerText == "執行腳本") {
        btnMonkey.innerText = "中斷執行";
        execTimes = 1; startTime = null;
        log.style.display = "block";
        execScript();
        checkButton();
      } else {
        stopScript()
      }
    });

    btnClear.addEventListener('click', function(e) {
      clearData();
      checkButton();
    });
    
    function execScript(params) {
      
      if(execTimes == 0) return;
      let index = typeof params == "object" ? params.index + 1 : 0;
      // console.log(`${execTimes}/${maxTimes}, index: ${index}`)
      if(index >= ds.length && execTimes >= maxTimes) {
        stopScript();
        alert(`指令全部執行完畢...`);
      } else {
        if(index >= ds.length) {
          execTimes++;
          index = 0;
        }
        if(index == 0) {
          if(logIntervalId) clearInterval(logIntervalId);
          monkeyLog(`${execTimes}/${maxTimes} 指令執行中...`);
        }
        let data = ds[index];

        clsTable.focusRow(index + 1, true);
        moveCursor(data);
        ws.send(JSON.stringify(Object.assign(data, {type: "tap", index})));
      }
    }

    function stopScript(params) {
      execTimes = 0;
      btnMonkey.innerText = "執行腳本";
      clsTable.focusRow(-1);
      clearInterval(logIntervalId);
      setTimeout(() => {
        // log.querySelectorAll('div').forEach(div => div.remove());
        log.innerHTML = "";
        log.style.display = "none";
        checkButton();            
      }, 1000);
    }

    function monkeyLog(params) {
      if(logIntervalId) clearInterval(logIntervalId);
      const div = document.createElement('div');
      div.style.whiteSpace = 'pre';
      // div.style.height = '100%';
      div.style.fontSize = "16px";
      div.style.overflow = 'auto';
      div.innerHTML = `<span style="font-weight: bold;font-size: 20px;">${(new Date()).toLocaleTimeString('zh-Hant', { hour12: false })}：${params}</span>`;
      log.prepend(div);
      const span = document.createElement('span');
      span.style.fontSize = "18px";
      span.style.marginLeft = "20px"
      div.appendChild(span); 
      let start = (new Date()).getTime();
      logIntervalId = setInterval(() => {
        let now = (new Date()).getTime();
        span.innerText = ((now - start) / 1000).toFixed(1) + " 秒";
      }, 100);  
    }
    function checkButton() {
      btnClear.disabled = ds.length === 0 || execTimes > 0;
      btnMonkey.disabled = ds.length === 0;
      select.disabled = execTimes > 0;
    }
    function clearData() {
      ds = [];
      clsTable.clear();
      delete window.localStorage["monkey_script"];
    }

    function addOption(text, value) {
      const option = document.createElement("option");
      option.text = text;
      option.value = typeof value == "undefined" ? text: value;
      select.add(option);
    }

    function sendMsg(params, error) {
      msg.innerHTML = (new Date()).toLocaleTimeString('zh-Hant', { hour12: false }) + "：" + params 
        + (typeof error == "object" ? error.message : error || "")
      ;
    }
  </script>
</body>
</html>