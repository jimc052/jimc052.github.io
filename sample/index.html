<!DOCTYPE html>
<html>
  <head>
    <title>範本</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <style type="text/css">
      /**/
      table {
        border-collapse: collapse;
        width: 100%;
      }

      table, th, td {
        border: 1px solid #eeeeee;
      }
      h3 {
        margin-bottom: 0px;
        color:rgb(45, 140, 240);
      }
      td:first-child {
        color: rgb(45, 140, 240);
      }
      td {
        height: 28px;
        padding: 3px;
      }
      tr.error {
        background-color: #c01921;
      }
      tr.error td {
        color: white;
      }
      h3.error::after{
        content:"(有錯誤)";
        color:#c01921;
        background-color: #eeeeee;
        margin-left: 10px;
      }
    </style>
    <script>
      /**/
    </script>
  </head>  
  <body>
    <h3 id="tmmf" style="margin-top: 0px;">TMMF</h3>
    <table id="TMMF" border="1" class="parent"></table>
    <h3 id="mguielec">MGUIELEC</h3>
    <table id="MGUIELEC" border="1" class="parent"></table>
    <h3 id="pos_h">POS_H</h3>
    <table id="POS_H" border="1" class="parent"></table>
  </body>
  <script>
    var pos_h = {};
    function parseData(client, server) {
      pos_h = {};
      var arrTMMF = "W_TODAY,SER_NO,TK_H,TK_NO".split(",")
      for(var i = 0; i < arrTMMF.length; i++){
        var key = arrTMMF[i].trim();
        var row = document.createElement("TR");
        document.getElementById("TMMF").appendChild(row); 
        var td = document.createElement("TD");
        td.innerHTML = "" + key;
        row.appendChild(td); 

        td = document.createElement("TD");
        td.innerHTML = server.TMMF[key];
        row.appendChild(td);
        
        if(client.TMMF[key] != server.TMMF[key]){
          row.className = "error";
          document.getElementById("tmmf").className = "error";
          
          td = document.createElement("TD");
          td.innerHTML = client.TMMF[key];
          row.appendChild(td);
        } else {
          td.setAttribute("colspan", 2)
        }
      }

      if(typeof server.MGUIELEC == "object") {
        var arrMGUIELEC = "T_TK_H,S_NO,E_NO,N_NO,END_FLAG".split(",")
        for(var i = 0; i < arrMGUIELEC.length; i++){
          var key = arrMGUIELEC[i].trim();
          var row = document.createElement("TR");
          document.getElementById("MGUIELEC").appendChild(row); 
          var td = document.createElement("TD");
          td.innerHTML = "" + key;
          row.appendChild(td); 

          td = document.createElement("TD");
          td.innerHTML = server.MGUIELEC[key];
          row.appendChild(td);

          if(client.MGUIELEC[key] != server.MGUIELEC[key]){
            row.className = "error";
            document.getElementById("mguielec").className = "error";

            td = document.createElement("TD");
            td.innerHTML = client.MGUIELEC[key];
            row.appendChild(td); 
          } else {
            td.setAttribute("colspan", 2)
          }
        }        
      } else {
        document.getElementById("MGUIELEC").style.display = "none";
        document.getElementById("mguielec").style.display = "none";
      }
      console.log(client.POS_H)
      if(client.POS_H.length == 0 && server.POS_H.length == 0) {
        document.getElementById("pos_h").style.display = "none";
        return;
      }
      while(client.POS_H.length > 0 || server.POS_H.length > 0){
        var T_SER_NO1 = server.POS_H.length > 0 ? server.POS_H[0].T_SER_NO : undefined;
        var T_SER_NO2 = client.POS_H.length > 0 ? client.POS_H[0].T_SER_NO : undefined;

        if(typeof T_SER_NO1 == "string" && T_SER_NO1 == T_SER_NO2) {
          pos_h[T_SER_NO1] = {
            client: client.POS_H.splice(0, 1)[0],
            server: server.POS_H.splice(0, 1)[0]
          }
          continue;
        } 
        else if((typeof T_SER_NO1 == "string" && typeof T_SER_NO2 == "undefined")
         || T_SER_NO1 > T_SER_NO2
        ) {
          pos_h[T_SER_NO1] = {
            server: server.POS_H.splice(0, 1)[0]
          }
          continue;
        } 
        else if((typeof T_SER_NO2 == "string" && typeof T_SER_NO1 == "undefined")
          || T_SER_NO2 > T_SER_NO1
        ) {
          pos_h[T_SER_NO2] = {
            client: client.POS_H.splice(0, 1)[0]
          }
          continue;
        }
      }
      for(var key in pos_h) {
        var row = document.createElement("TR");
        document.getElementById("POS_H").appendChild(row);

        var row2 = document.createElement("TR");
        document.getElementById("POS_H").appendChild(row2); 
        row2.id = key;

        var td = document.createElement("TD");
        td.innerHTML = "<a href='javascript:showPOS_H(\"" + key + "\");'>" + key + "</a>";
        row.appendChild(td); 

        var x = pos_h[key].server;
        var y = pos_h[key].client;

        td = document.createElement("TD");
        td.innerHTML = typeof x == "object" ? x.AMOUNT : y.AMOUNT;
        row.appendChild(td);

        td = document.createElement("TD");
        td.innerHTML = typeof x == "object" ? x.T_TK_H + x.T_TK_NO 
          : y.T_TK_H + y.T_TK_NO;
        row.appendChild(td);
        if(typeof x == "object" && typeof y == "object") {
            for(var key2 in x){
              if(x[key2] != y[key2]) {
                row.className = "error";
                document.getElementById("pos_h").className = "error";
                break;
              }
            }          
        } else {
          row.className = "error";
          document.getElementById("pos_h").className = "error";
        }
      }
    }
    function  showPOS_H(params) {
      var row = document.getElementById(params);
      var t = document.querySelector(".childTable" + params);
      row.innerHTML = "";
      if(t != null) {
        return;
      }

      var td = document.createElement("TD");
      td.style.color = "black";
      td.style.padding = "0px 0px 5px 10px"
      row.appendChild(td);
      td.setAttribute("colspan", 3);

      var table = document.createElement("TABLE");
      td.appendChild(table); 
      
      table.className = "childTable" + params;
      table.style.backgroundColor = "#ddd";

      var o = typeof pos_h[params].client == "object" ? pos_h[params].client : pos_h[params].server;
      var arr = "T_SER_NO,T_TIME,T_TK_H,T_TK_NO,AMOUNT,FLG_CLOSE,T_FLAG1,RAND_CODE".split(",");
      for(var i = 0; i < arr.length; i++) {
        var key = arr[i].trim();
        if(key == "RAND_CODE" && typeof pos_h[params].client == "object" && typeof pos_h[params].server == "object" 
          && pos_h[params].client[key] == null) {
            continue;
        }

        row = document.createElement("TR");
        table.appendChild(row); 

        td = document.createElement("TD");
        td.innerHTML = key;
        row.appendChild(td);
        
        var s1 = typeof pos_h[params].server == "object" ? pos_h[params].server[key] : "";
        var s2 = typeof pos_h[params].client == "object" ? pos_h[params].client[key] : ""
        td = document.createElement("TD");
        td.innerHTML = s1;
        row.appendChild(td);
        td.style.minWidth = "40px";

        if(s1 != s2) {
          row.className = "error";
          td = document.createElement("TD");
          td.innerHTML = s2;
          row.appendChild(td);
          td.style.minWidth = "40px"            
        } else {
          td.setAttribute("colspan", 2)
        }
      }
    }

    var client = {"POS_H": [
        {"RAND_CODE":"9343","T_FLAG1":"1","FLG_CLOSE":"N","AMOUNT":101,"T_TK_H":"AA","T_SER_NO":"000002","T_TK_NO":"00000001","T_TIME":"1514","TOTAL":100},
        {"RAND_CODE":"7153","T_FLAG1":"1","FLG_CLOSE":"N","AMOUNT":200,"T_TK_H":"AA","T_SER_NO":"000001","T_TK_NO":"00000002","T_TIME":"1514","TOTAL":200}
      ],
      "MGUIELEC":
        {"END_FLAG":"0","N_NO":"00000003","E_NO":"00000003","S_NO":"00000001","T_TK_H":"AA"},
        "TMMF":{"TM_NO":"001","W_TODAY":"20201005","SER_NO":3,"STATUS":"1","TK_H":"AA","TK_NO":"3","CLEAR_NO":1,"CLASSNO":"1","CASH_CODE":"001","TM_NAME":"TM001","MONEY":5000,"PRN_CNT":1,"IP_ADDRESS":"","IP_ADDRESS1":"192.168.0.123","FLAG12":"0","FLAG9":"C","FLAG7":"0","FLAG17":"1","FLAG4":"G","FLAG6":"B","FLAG8":"0","R_CUS":"0","FLAG5":"0","FLAG14":"3","FLAG13":"1","TK_QTY":10,"PRNTYPE_NO":"","IP_ADDRESS2":"192.168.0.74","FLAG19":"0","REV_NO":"2020-09-22T17:30","LOGFLAG":"F","CASH_FLAG":"11111","CASH_NAME":"收銀員","LEVEL_1":"5"}}
    var server = {"POS_H":[
        {"FLG_CLOSE":"N","T_TK_H":"AA","T_TIME":"1514","T_SER_NO":"000002","T_FLAG1":"1","T_TK_NO":"00000001","AMOUNT":101,"RAND_CODE":"9343","TOTAL":100},
        {"FLG_CLOSE":"N","T_TK_H":"AA","T_TIME":"1514","T_SER_NO":"000001","T_FLAG1":"1","T_TK_NO":"00000004","AMOUNT":200,"RAND_CODE":"7153","TOTAL":200}
      ],
      "TMMF":{"SER_NO": 3,"TK_NO":3,"TK_H":"AA", "W_TODAY": "20200101"},
      "MGUIELEC":{"T_TK_H":"AA","END_FLAG":"1","S_NO":"00000001","N_NO":"00000003","E_NO":"00000003"}}
    // parseData(client, server);
  </script>
</html>