<!DOCTYPE html>
<html>

<head>
  <title>時雨-整合</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src *; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'; media-src *; img-src * filesystem: data:">
  <style>
    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      /* user-select: none; */
      font-family: 'Times New Roman', 'Helvetica Neue', 微軟正黑體, 'Microsoft Jhenghei', Helvetica, Arial, sans-serif;
      font-size: 16px;
    }

    body {
      /* margin: 10px; */
      background-color: #ebecf0;
      padding: 0px 0px;
      color: rgb(0, 0, 0);
    }

    html,
    body {
      min-height: 100% !important;
      height: 100%;
    }

    body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 16px;
      width: 100%;
    }

    table thead tr:first-child td {
      text-align: center;
      color: blue;
      font-weight: 700;
      background: #eee;
    }

    tr.remove > td {
      color: red;
    }

    td {
      border: 1px solid black;
      padding: 5px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div style="padding: 5px 0;">
    <input type="radio" name="時雨" id="時雨1" value="時雨1" onchange="trim_時雨(1);" />
    <label for="時雨1" style="margin-right: 10px;">全部</label>

    <input type="radio" name="時雨" id="時雨2" value="時雨2" onchange="trim_時雨(2);" />
    <label for="時雨2" style="margin-right: 10px;">重複-全部</label>

    <input type="radio" name="時雨" id="時雨3" value="時雨3" onchange="trim_時雨(3);" />
    <label for="時雨3" style="margin-right: 10px;">重複-未刪除</label>
  </div>
  <div style="flex: 1; overflow: scroll">
    <table>
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</body>
<script>
  let mode = "", 刪除記錄 = "";
  let ds時雨 = [];
  let btnRemove  = `<button style="color: white; background: red;" onclick='remove({item}, {index})'>刪除</button>`;
  let btnRecover  = `<button style="color: white; background: green;" onclick='recover({item}, {index})'>復原</button>`;

  window.onload = async function () {
    // trim_時雨()
    let radio = "1";
    if (typeof window.localStorage["japanese-時雨-radio"] == "string") {
      radio = window.localStorage["japanese-時雨-radio"];
    }
    let input = document.querySelectorAll("input[type='radio']")
    input[radio - 1].checked = true;
    trim_時雨(radio);
  }

  function trim_時雨(_mode) {
    mode = _mode;
    
    if (typeof window.localStorage["japanese-時雨-刪除記錄"] == "string") {
      刪除記錄 = window.localStorage["japanese-時雨-刪除記錄"];
    }

    window.localStorage["japanese-時雨-radio"] = mode;
    let thead = document.querySelector("thead");
    let tbody = document.querySelector("tbody");
    let cols = "假名,漢字,中文,級別,重音,分類,來源".split(","); 
    let header = thead.querySelectorAll("td");
    if(header.length == 0) {
      let row = thead.insertRow();
      let cell = row.insertCell();
      cell.innerHTML = "項次";
      for (let j = 0; j < cols.length; j++) {
        cell = row.insertCell();
        cell.innerHTML = cols[j];
      }
      cell = row.insertCell();
      cell.innerHTML = "刪除";
    }

    tbody.innerHTML = "";
    setTimeout(() => {
      let s = "";
      for (let i = 3; i <= 5; i++) {
        s += (s.length > 0 ? ",\n" : "") + window.localStorage["japanese-時雨-N" + i];
      }
      ds時雨 = JSON.parse(`[${s}]`);

      if (mode != "1") {
        ds時雨.sort(function (a, b) {
          if (a["假名"] > b["假名"])
            return -1;
          else if (a["假名"] < b["假名"])
            return 1;
          else
            return 0;
        });
      }

      let color = "transparent", delStr = "";
      for (let i = 0; i < ds時雨.length; i++) {
        let data = ds時雨[i];
        
        let row = tbody.insertRow();
        row.id = "tr_時雨_" + i;
        let cell = row.insertCell();
        cell.innerHTML = i + 1;
        for (let j = 0; j < cols.length; j++) {
          let col = cols[j];
          cell = row.insertCell();
          cell.innerHTML = typeof data[col] == "string" ? data[col] : "";
        }
        cell = row.insertCell();

        if (mode != "1") {
          if (i > 0 && ds時雨[i - 1]["假名"] == ds時雨[i]["假名"]) {
            color = color == "pink" ? "#F6DDCC" : "pink";
            let index = 2;
            if (ds時雨[i - 1]["中文"] == ds時雨[i]["中文"]) {
              let 分類1 = (typeof ds時雨[i - 1]["分類"] == "string" ? ds時雨[i - 1]["分類"] : "");
              let 分類2 = (typeof ds時雨[i]["分類"] == "string" ? ds時雨[i]["分類"] : "");
              index = 分類1.length > 0 ? 0 : (分類2.length > 0 ? -1 : 2);
              // console.log(ds時雨[i]["中文"] + ": " + index + ", " + 分類1 + ", " + 分類2)
            }

            let row2 = document.querySelector("#tr_時雨_" + (i - 1));
            if (index == 2) {
              row.style.background = color;
              if(!(mode == "3" && 刪除記錄.indexOf(ds時雨[i]["級別"] + "-" + ds時雨[i]["來源"]) > -1)) {
                row.setAttribute("repeat", "true");
              }
              
              if(row2 != null) {
                row2.style.background = color;
                if(!(mode == "3" && 刪除記錄.indexOf(ds時雨[i -1]["級別"] + "-" + ds時雨[i-1]["來源"]) > -1)) {
                  row2.setAttribute("repeat", "true");
                }
              }
            } 
            else if (index == -1 || index == 0) {
              if (mode == "2") {
                row.style.background = color;
                row.setAttribute("repeat", "true");
                if(row2 != null) {
                  row2.style.background = color;
                  row2.setAttribute("repeat", "true");                
                }
              }

              if(刪除記錄.indexOf(ds時雨[i + index]["級別"] + "-" + ds時雨[i + index]["來源"]) == -1) {
                delStr += (delStr.length > 0 ? "\n" : "") + 
                  ds時雨[i + index]["級別"] + "-" + ds時雨[i + index]["來源"];
              }
            }
          }
        }
        let data2 = ds時雨[i]["級別"] + "-" + ds時雨[i]["來源"];
        if(刪除記錄.indexOf(data2) > -1 || delStr.indexOf(data2) > -1) {
          row.classList.add("remove");
          cell.innerHTML = btnRecover.replace("{index}", i).replace("{item}", JSON.stringify(ds時雨[i]));
        } else {
          cell.innerHTML = btnRemove.replace("{index}", i).replace("{item}", JSON.stringify(ds時雨[i]));
        }
      }

      if(delStr.length > 0) {
        刪除記錄 += (刪除記錄.length > 0 ? "\n" : "") + delStr
        window.localStorage["japanese-時雨-刪除記錄"] = 刪除記錄;
      }
      
      if (mode != "1") {
        let rows = tbody.querySelectorAll("tr");
        for (let i = rows.length - 1; i >= 0; i--) {
          if (rows[i].getAttribute("repeat") != "true") {
            tbody.deleteRow(i)
          }
        }
        if (mode == "3") {
          rows = tbody.querySelectorAll("tr");
          let i = 0;
          while(i < rows.length - 1) {
            color = color == "pink" ? "#F6DDCC" : "pink";
            rows[i].style.background = color;
            let td1 = rows[i].querySelectorAll("td");
            let td2 = rows[i + 1].querySelectorAll("td");
            console.log(i + ": " + td1[1].innerHTML + "," + td2[1].innerHTML)
            if(td1[1].innerHTML == td2[1].innerHTML) {
              rows[i + 1].style.background = color;
              i++;
            }
            i++;
          }
        }
      }
    }, 300);
  }

  function remove(item, index) {
    刪除記錄 = item["級別"] + "-" + item["來源"] + (刪除記錄.length > 0 ? "\n" : "") + 刪除記錄;

    let row = document.querySelector("#tr_時雨_" + (index));
    let td = row.querySelectorAll("td");
    td[td.length - 1].innerHTML = btnRecover.replace("{index}", index).replace("{item}", JSON.stringify(item));
    row.classList.add("remove");

    window.localStorage["japanese-時雨-刪除記錄"] = 刪除記錄;
  }

  function recover(item, index) {
    let data = item["級別"] + "-" + item["來源"];
    刪除記錄 = 刪除記錄.replace(data + "\n", "").replace(data, "")
    let row = document.querySelector("#tr_時雨_" + (index));
    let td = row.querySelectorAll("td");
    td[td.length - 1].innerHTML = btnRemove.replace("{index}", index).replace("{item}", JSON.stringify(item));
    row.classList.remove("remove");
    window.localStorage["japanese-時雨-刪除記錄"] = 刪除記錄;
  }

  
</script>

</html>